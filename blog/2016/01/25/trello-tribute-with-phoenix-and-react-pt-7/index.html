<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie10 lt-ie9 lt-ie8 lt-ie7" lang=en-us><![endif]--> <!--[if IE 7]><html class="no-js lt-ie10 lt-ie9 lt-ie8" lang=en-us><![endif]--> <!--[if IE 8]><html class="no-js lt-ie10 lt-ie9" lang=en-us><![endif]--> <!--[if IE 9]><html class="no-js lt-ie10 lt-ie9" lang=en-us><![endif]--> <!--[if lt IE 10]><html class="no-js lt-ie10" lang=en-us><![endif]--> <!--[if !IE]>><![endif]--> <html class=no-js lang=en> <head> <title>Trello tribute with Phoenix and React (pt.7) - Code, Love & Boards</title> <meta charset=utf-8 content='text/html' http-equiv=content-type> <meta content='ie=edge,chrome=1' http-equiv=x-ua-compatible> <meta content='Setting up sockets and channels for real-time features' name=description> <meta content='Ricardo García Vega - http://twitter.com/bigardone' name=author> <meta content='elixir, phoenix, react, redux' name=keywords> <meta content='initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width' name=viewport> <link href='//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css' rel=stylesheet> <link href="//fonts.googleapis.com/css?family=Montserrat:400,700|Lora:400,700" media=screen rel=stylesheet /> <link href="../../../../../stylesheets/blog-ed6b1e0f.css" media=all rel=stylesheet /> <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/tomorrow.min.css' rel=stylesheet> <script src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js'></script> <link href='/images/apple-touch-icon-57x57-6e598dc4.png' rel=apple-touch-icon sizes=57x57> <link href='/images/apple-touch-icon-114x114-5be964ba.png' rel=apple-touch-icon sizes=114x114> <link href='/images/apple-touch-icon-72x72-70084a85.png' rel=apple-touch-icon sizes=72x72> <link href='/images/apple-touch-icon-144x144-1dbb56c1.png' rel=apple-touch-icon sizes=144x144> <link href='/images/apple-touch-icon-60x60-d05a5ea9.png' rel=apple-touch-icon sizes=60x60> <link href='/images/apple-touch-icon-120x120-5dafce59.png' rel=apple-touch-icon sizes=120x120> <link href='/images/apple-touch-icon-76x76-b2c0d784.png' rel=apple-touch-icon sizes=76x76> <link href='/images/apple-touch-icon-152x152-45595360.png' rel=apple-touch-icon sizes=152x152> <link href='/images/favicon-160x160-944ce76e.png' rel=icon sizes=160x160 type='image/png'> <link href='/images/favicon-96x96-b7e4e089.png' rel=icon sizes=96x96 type='image/png'> <link href='/images/favicon-32x32-b7f34a79.png' rel=icon sizes=32x32 type='image/png'> <link href='/images/favicon-16x16-2712c528.png' rel=icon sizes=16x16 type='image/png'> <meta content='#9f00a7' name=msapplication-TileColor> <meta content='/images/mstile-144x144-028d4c4c.png' name=msapplication-TileImage> <script>
  var _StatHat = _StatHat || [];
  _StatHat.push(['_setUser', 'NzIzMCDaNaL5bvEP1HQkMYwfYsQe']);
  (function() {
          var sh = document.createElement('script'); sh.type = 'text/javascript';
          sh.async = true;
          sh.src = '//www.stathat.com/javascripts/api.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(sh, s);
  })();
</script> <link href='https://blog.diacode.com/trello-clone-with-phoenix-and-react-pt-7' rel=canonical> <link href='//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css' rel=stylesheet> <script src='//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js'></script> <script>
  window.addEventListener("load", function(){
  window.cookieconsent.initialise({
    "palette": {
      "popup": {
        "background": "#252e39"
      },
      "button": {
        "background": "#217dbb"
      }
    },
    "theme": "classic",
    "position": "bottom-right"
  })});
</script> </head> <body class=blog> <header id=main_header> <div class=main-logo> <a href="/"><img src="../../../../../images/logo-cd52bd68.png"/> </a> </div> <div class=container> <section class=center> <h1>Trello tribute with Phoenix and React (pt.7)</h1> <h3></h3> <div class=meta-data> <hr> posted Jan 25, 2016 on <a class=tag href="/blog/tags/elixir.html">elixir</a> <a class=tag href="/blog/tags/phoenix.html">phoenix</a> <a class=tag href="/blog/tags/react.html">react</a> <a class=tag href="/blog/tags/redux.html">redux</a> </div> </section> </div> </header> <section id=main_content> <div class=container> <section> <article> <div class=index> <p>This post belongs to the <strong>Trello tribute with Phoenix Framework and React</strong> series.</p> <ol> <li><a href="/blog/2016/01/04/trello-tribute-with-phoenix-and-react-pt-1">Intro and selected stack</a></li> <li><a href="/blog/2016/01/11/trello-tribute-with-phoenix-and-react-pt-2">Phoenix Framework project setup</a></li> <li><a href="/blog/2016/01/12/trello-tribute-with-phoenix-and-react-pt-3">The User model and JWT auth</a></li> <li><a href="/blog/2016/01/14/trello-tribute-with-phoenix-and-react-pt-4/">Front-end for sign up with React and Redux</a></li> <li><a href="/blog/2016/01/18/trello-tribute-with-phoenix-and-react-pt-5/">Database seeding and sign in controller</a></li> <li><a href="/blog/2016/01/20/trello-tribute-with-phoenix-and-react-pt-6/">Front-end authentication with React and Redux</a></li> <li><a href="/blog/2016/01/25/trello-tribute-with-phoenix-and-react-pt-7/">Sockets and channels</a></li> <li><a href="/blog/2016/01/28/trello-tribute-with-phoenix-and-react-pt-8/">Listing and creating boards</a></li> <li><a href="/blog/2016/02/04/trello-tribute-with-phoenix-and-react-pt-9/">Adding new board members</a></li> <li><a href="/blog/2016/02/15/trello-tribute-with-phoenix-and-react-pt-10/">Tracking connected board members</a></li> <li><a href="/blog/2016/02/24/trello-tribute-with-phoenix-and-react-pt-11/">Adding lists and cards</a></li> <li><a href="/blog/2016/03/04/trello-tribute-with-phoenix-and-react-pt-12/">Deploying our application on Heroku</a></li> </ol> <a href="https://phoenix-trello.herokuapp.com/"><i class="fa fa-cloud"></i> Live demo</a> | <a href="https://github.com/bigardone/phoenix-trello"><i class="fa fa-github"></i> Source code</a> </div> <h2>Sockets and channels</h2> <p>In the <a title="Part 6" href="/blog/2016/01/20/trello-tribute-with-phoenix-and-react-pt-6">last post</a> we finished the authentication process and now we are ready to start with all the fun. From now on we are going to heavily rely on <strong>Phoenix</strong>&#39;s real-time features for connecting both the front-end and the back-end. Any event affecting a user&#39;s board will be pushed to him so the changes are automatically displayed on his screen.</p> <p>We can think of channels more or less as common controllers. But instead of handling a request and returning a response to a single connection, they handle bidirectional events for a given topic which can be broadcasted to multiple connections. To configure them, <strong>Phoenix</strong> uses socket handlers which authenticates and identifies a socket connection and also defines channel routes that specify which channel is going to handle each request.</p> <h3>The user socket</h3> <p>When creating a new <strong>Phoenix</strong> application, it automatically sets a default socket configuration for us:</p> <pre><code class="elixir"># lib/phoenix_trello/endpoint.ex

defmodule PhoenixTrello.Endpoint do
  use Phoenix.Endpoint, otp_app: :phoenix_trello

  socket &quot;/socket&quot;, PhoenixTrello.UserSocket

  # ...
end

</code></pre> <p>The <code>UserSocket</code> is also created, but we need to make some changes to it in order to make it handle the right messages:</p> <pre><code class="elixir"># web/channels/user_socket.ex

defmodule PhoenixTrello.UserSocket do
  use Phoenix.Socket

  alias PhoenixTrello.{Repo, User}

  # Channels
  channel &quot;users:*&quot;, PhoenixTrello.UserChannel
  channel &quot;boards:*&quot;, PhoenixTrello.BoardChannel

  # Transports
  transport :websocket, Phoenix.Transports.WebSocket
  transport :longpoll, Phoenix.Transports.LongPoll

  # ...
end

</code></pre> <p>Basically we are going to have two different channels:</p> <ul> <li>The <code>UserChannel</code> will handle messages with any topic starting with <code>&quot;users:&quot;</code> and we will use it to inform users about events related to them, for example when they are invited to join a board for instance.</li> <li>The <code>BoardChannel</code> will have the most functionality; handling messages for managing boards, lists and cards, informing any user who might be viewing the board in that exact moment about any change.</li> </ul> <p>We also need to implement the <code>connect</code> and <code>id</code> functions which will look like this:</p> <pre><code class="elixir"># web/channels/user_socket.ex

defmodule PhoenixTrello.UserSocket do
  # ...

  def connect(%{&quot;token&quot; =&gt; token}, socket) do
    case Guardian.decode_and_verify(token) do
      {:ok, claims} -&gt;
        case GuardianSerializer.from_token(claims[&quot;sub&quot;]) do
          {:ok, user} -&gt;
            {:ok, assign(socket, :current_user, user)}
          {:error, _reason} -&gt;
            :error
        end
      {:error, _reason} -&gt;
        :error
    end
  end

  def connect(_params, _socket), do: :error

  def id(socket), do: &quot;users_socket:#{socket.assigns.current_user.id}&quot;
end
</code></pre> <p>When the <code>connect</code> function is called with a <code>token</code> as parameter it will verify it, get the user from the token using the <code>GuardianSerializer</code> we created on <a title="Part 3" href="/blog/2016/01/12/trello-tribute-with-phoenix-and-react-pt-3">part 3</a>, and assign it to the socket so it&#39;s available in the channels if we might need it. Furthermore, this will also prevent unauthenticated users from connecting to the socket.</p> <h3>The user channel</h3> <p>Now that we have set up the socket, let&#39;s move on to the <code>UserSocket</code> which is very simple:</p> <pre><code class="elixir"># web/channels/user_channel.ex

defmodule PhoenixTrello.UserChannel do
  use PhoenixTrello.Web, :channel

  def join(&quot;users:&quot; &lt;&gt; user_id, _params, socket) do
    {:ok, socket}
  end
end

</code></pre> <p>This channel will allow us to broadcast any user related message from anywhere, handling it from the front-end. In our particular case we&#39;ll use it to broadcast a board in which a user has been added as a member so we can add that new board to the user&#39;s boards list. We could also use it for displaying notifications about other boards he owns, or whatever you can imagine.</p> <h3>Connecting to the socket and channel</h3> <p>Before continuing let&#39;s recall what we did at the end of the <a title="Part 6" href="/blog/2016/01/20/trello-tribute-with-phoenix-and-react-pt-6">last post</a>... after authenticating the user, whether it was using the sign in form or using a previously stored <code>phoenixAuthToken</code>, we needed to retrieve the <code>currentUser</code> to dispatch it to the Redux store so we could display the user&#39;s avatar and name in the header. This looks like a good place to connect to the socket and channel as well, so let&#39;s do some refactoring:</p> <pre><code class="javascript">// web/static/js/actions/sessions.js

import Constants                          from &#39;../constants&#39;;
import { Socket }                         from &#39;../phoenix&#39;;

// ...

export function setCurrentUser(dispatch, user) {
  dispatch({
    type: Constants.CURRENT_USER,
    currentUser: user,
  });

  const socket = new Socket(&#39;/socket&#39;, {
    params: { token: localStorage.getItem(&#39;phoenixAuthToken&#39;) },
  });

  socket.connect();

  const channel = socket.channel(`users:${user.id}`);

  channel.join().receive(&#39;ok&#39;, () =&gt; {
    dispatch({
        type: Constants.SOCKET_CONNECTED,
        socket: socket,
        channel: channel,
      });
  });
};

// ...

</code></pre> <p>After dispatching the user we create a new <code>Socket</code> from the <code>Phoenix</code> js library adding the <code>phoenixAuthToken</code> token required to establish the connection, and we call the <code>connect</code> function. We proceed to create a new user <code>channel</code> from the <code>socket</code> and join it. When we receive the <code>ok</code> message from the join message, we dispatch the <code>SOCKET_CONNECTED</code> action to store both the socket and channel into the store:</p> <pre><code class="javascript">// web/static/js/reducers/session.js

import Constants from &#39;../constants&#39;;

const initialState = {
  currentUser: null,
  socket: null,
  channel: null,
  error: null,
};

export default function reducer(state = initialState, action = {}) {
  switch (action.type) {
    case Constants.CURRENT_USER:
      return { ...state, currentUser: action.currentUser, error: null };

    case Constants.USER_SIGNED_OUT:
      return initialState;

    case Constants.SOCKET_CONNECTED:
      return { ...state, socket: action.socket, channel: action.channel };

    case Constants.SESSIONS_ERROR:
      return { ...state, error: action.error };

    default:
      return state;
  }
}

</code></pre> <p>The main reason for storing them in the state is because we are going to need them in many places so having them in the state makes them available to components through their <code>props</code>.</p> <p>Now that the user is authenticated, connected to the socket and joined to his channel, the <code>AuthenticatedContainer</code> will render the <code>HomeIndexView</code> view where we will display all the boards owned by the user as well as the ones he has been invited as a member. In the next post we will cover how to create a new board and invite existing users, using channels to broadcast the resulting data to the involved users. Meanwhile, don&#39;t forget to check out the live demo and final source code:</p> <div class=btn-wrapper> <a href="https://phoenix-trello.herokuapp.com/" target=_blank class=btn><i class="fa fa-cloud"></i> Live demo</a> <a href="https://github.com/bigardone/phoenix-trello" target=_blank class=btn><i class="fa fa-github"></i> Source code</a> </div> <p>Happy coding!</p> <div id=disqus_thread></div> <script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'codeloveandboards'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script> <noscript> Please enable JavaScript to view the <a href='//disqus.com/?ref_noscript'>comments powered by Disqus.</a> </noscript> <a class=dsq-brlink href='//disqus.com'> comments powered by <span class=logo-disqus>Disqus</span> </a> </article> </section> </div> </section> <footer id=main_footer> <ul class=article-nav> <li class=previous> <a href="/blog/2016/01/20/trello-tribute-with-phoenix-and-react-pt-6/"><h4>previous post</h4> <h3> Trello tribute with Phoenix and React (pt.6) </h3> <div class=meta-data> <hr> posted Jan 20, 2016 on elixir, phoenix, react, redux </div> </a> </li> <li class=next> <a href="/blog/2016/01/28/trello-tribute-with-phoenix-and-react-pt-8/"><h4>next post</h4> <h3> Trello tribute with Phoenix and React (pt.8) </h3> <div class=meta-data> <hr> posted Jan 28, 2016 on elixir, phoenix, react, redux </div> </a> </li> </ul> <section> <div class=container> <div class=center> <ul> <li> <a href='/blog'>Archives</a> </li> <li> <a href='//feeds.feedburner.com/CodeLoveAndBoards' target=_blank>RSS</a> </li> </ul> Copyright © 2018 - Ricardo García Vega - Code, Love & Boards! </div> </div> </section> </footer> <script src="../../../../../javascripts/blog-5ddb0520.js"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-37802122-1', 'codeloveandboards.com');
  ga('send', 'pageview');
</script> <script>
  _StatHat.push(["_trackCount", "g2pcD9xou7DlR0DtndiwvSBBYU5k", 1.0]);
</script> </body> </html>